{
    runCommand: {
           aggregate : 'ipfillorders',
           pipeline : [ 
    { $match: { statusflag: "A",_id:{"$oid":$P{searchcriteria}}}},
{ $unwind: { path: "$ipfillorderitems"  ,preserveNullAndEmptyArrays: true }},
{ $lookup: { from: 'drugmasters', localField: 'ipfillorderitems.drugmasteruid', foreignField: '_id', as: 'drugmaster' } },
{ $unwind: { path: '$drugmaster', preserveNullAndEmptyArrays: true } },
{ $lookup: { from: 'users', localField: 'ipfillorderitems.careprovideruid', foreignField: '_id', as: 'careproviderdetails' } },
{ $unwind: { path: '$careproviderdetails', preserveNullAndEmptyArrays: true } },
{ $lookup: { from: 'frequencies', localField: 'ipfillorderitems.frequencyuid', foreignField: '_id', as: 'frequency' } },
{ $unwind: { path: '$frequency', preserveNullAndEmptyArrays: true } },
{ $lookup: { from: 'patients', localField: 'ipfillorderitems.patientuid', foreignField: '_id', as: 'patients' } },
{ $unwind: { path: '$patients', preserveNullAndEmptyArrays: true } },
{ $lookup: { from: 'patientvisits', localField: 'ipfillorderitems.patientvisituid', foreignField: '_id', as: 'patientvisits' } },
{ $unwind: { path: '$patientvisits', preserveNullAndEmptyArrays: true } },
{ $lookup: { from: "referencevalues", localField: "ipfillorderitems.quantityUOM", foreignField: "_id", as: "quantityuom" } },
{ $unwind: { path: "$quantityuom", preserveNullAndEmptyArrays: true } },
{ $lookup: { from: "referencevalues", localField: "ipfillorderitems.dosageUOM", foreignField: "_id", as: "dosageuom" } },
{ $unwind: { path: "$dosageuom", preserveNullAndEmptyArrays: true } },
{ $lookup: { from: "wards", localField: "warduid", foreignField: "_id", as: "ward" } },
{ $unwind: { path: "$ward", preserveNullAndEmptyArrays: true } },
{ $lookup: { from: "referencevalues", localField: "patients.titleuid", foreignField: "_id", as: "patienttitle" } },
{ $unwind: { path: "$patienttitle", preserveNullAndEmptyArrays: true } },
{ $lookup: { from: "referencevalues", localField: "patients.genderuid", foreignField: "_id", as: "patientgender" } },
{ $unwind: { path: "$patientgender", preserveNullAndEmptyArrays: true } },
{ $lookup: { from: "departments", localField: "departmentuid", foreignField: "_id", as: "department" } },
{ $unwind: { path: "$department", preserveNullAndEmptyArrays: true  } },
{ $lookup: { from: "inventorystores", localField: "invstoreuid", foreignField: "_id", as: "store" } },
{ $unwind: { path: "$store" , preserveNullAndEmptyArrays: true} },
{ $lookup: { from: "users", localField: "careprovideruid", foreignField: "_id", as: "filluser" } },
{ $unwind: { path: "$filluser" , preserveNullAndEmptyArrays: true } },
{ $lookup: { from: "orderitems", localField: "orderitemuid", foreignField: "_id", as: "orderitemdetails" } },
{ $unwind: { path: "$orderitemdetails" , preserveNullAndEmptyArrays: true } },
{ $unwind: { path: "$route", preserveNullAndEmptyArrays: true } },
{ $lookup: { from: "referencevalues", localField: "ipfillorderitems.formuid", foreignField: "_id", as: "form" } },
{ $unwind: { path: "$form", preserveNullAndEmptyArrays: true } },
{ $lookup: { from: "referencevalues", localField: "ipfillorderitems.dosageUOM", foreignField: "_id", as: "dosageUOM" } },
{ $unwind: { path: "$dosageUOM", preserveNullAndEmptyArrays: true } },
{ $lookup: { from: "referencevalues", localField: "ipfillorderitems.infusionrateuom", foreignField: "_id", as: "infusionrateUOM" } },
{ $unwind: { path: "$infusionrateUOM", preserveNullAndEmptyArrays: true } },
{ $lookup: { from: "referencevalues", localField: "ipfillorderitems.infusiondurationuom", foreignField: "_id", as: "infusiondurationuom" } },
{ $unwind: { path: "$infusiondurationuom", preserveNullAndEmptyArrays: true } },
{ $lookup: { from: 'orderitems', localField: 'ipfillorderitems.orderitemuid', foreignField: '_id', as: 'orderitem' } },
{ $unwind: { path: '$orderitem', preserveNullAndEmptyArrays: true } },
{ $lookup: { from: "referencevalues", localField: "ipfillorderitems.routeuid", foreignField: "_id", as: "route" } },
{ $unwind: { path: "$route", preserveNullAndEmptyArrays: true } },
{ $lookup: { from: "referencevalues", localField: "ipfillorderitems.formuid", foreignField: "_id", as: "form" } },
{ $unwind: { path: "$form", preserveNullAndEmptyArrays: true } },
 {
  $project:{
          "_id":"$_id",
          "itemname": "$drugmaster.name",
          "frequency": "$frequency.name",
          "filldate": "$orderdate",
          "patientfirstname": "$patients.firstname",
         "patientlastname": "$patients.lastname" ,
         "patientmiddlename": "$patients.middlename" ,
         "mrn": "$patients.mrn" ,
         "visitnumber": "$patientvisits.visitid",
         "quantity": "$ipfillorderitems.quantity",
         "ipfillquantity" : "$ipfillorderitems.ipfillquantity",
         "instructions":"$instructions",
         "quantityuom":"$quantityuom.valuedescription",
         "quantityuomcode":"$quantityuom.valuecode",
         "dosage":"$ipfillorderitems.dosage",
         "dosageuom":"$dosageuom.valuedescription",
         "dosageuomcode":"$dosageuom.valuecode",
         "frequencydescription" :"$frequency.description" ,
         "frequencytype" :"$frequency.type",
         "localfrequencydescription" :"$frequency.locallangdesc" ,
         "patientuid" : "$ipfillorderitems.patientuid",
         "patientvisituid":"$ipfillorderitems.patientvisituid",
         "patientdob":"$patients.dateofbirth",
         "patienttitle":"$patienttitle.valuedescription",
         "patienttitlelocal":"$patienttitle.locallangdesc",
         "patientgender":"$patientgender.valuedescription",
         "patientgenderlocal":"$patientgender.locallangdesc",
         "departmentcode":"$department.code",
         "departmentname":"$department.name",
         "storename":"$store.name",
         "storecode":"$store.code",
         "filluser" :"$filluser.name",
         "ipfillnumber":"$ipfillnumber",
         "isdosagenotapplicable" :"$drugmaster.dosagenotapplicable",
         "orderitemname":"$orderitemname",
         "admininstruction" : "$ipfillorderitems.administrationinstruction" ,
         "routelocallang" :"$route.locallanguagedesc",
         "dosageUOMlocal": "$dosageUOM.locallanguagedesc",
         "quantityUOMlocal": "$quantityUOM.locallanguagedesc",
         "dosagenotapplicabe" :"$drugmaster.dosagenotapplicable",
         "indication" :"$orderitem.orderiteminstructions",
         "careproviderlastname" :"$careproviderdetails.lastname",
         "careprovidertitle":"$careprovidertitle.valuedescription",
         "careprovidertitlelocal":"$careprovidertitle.locallanguagedesc",
         "careprovidername" :"$careproviderdetails.name",
         "routelocallang" :"$route.locallanguagedesc",
         "beduid2":{ $arrayElemAt: ["$patientvisits.bedoccupancy.beduid", -1 ] },
         "warduid2":{ $arrayElemAt: ["$patientvisits.bedoccupancy.warduid", -1 ] }    
}
},
   { $lookup: { from: 'wards', localField: 'warduid2', foreignField: '_id', as: 'ward' } },
   { $unwind: { path: '$ward', preserveNullAndEmptyArrays: true } },
   { $lookup: { from: 'beds', localField: 'beduid2', foreignField: '_id', as: 'bed' } },
   { $unwind: { path: '$bed', preserveNullAndEmptyArrays: true } },
{
$project:{
          "_id":1,
          "itemname": 1,
          "frequency": 1,
          "filldate": 1,
          "patientfirstname": 1,
         "patientlastname": 1 ,
         "patientmiddlename": 1,
         "mrn": 1 ,
         "visitnumber": 1,
         "quantity": 1,
         "ipfillquantity" : 1,
         "instructions":1,
         "quantityuom":1,
         "quantityuomcode":1,
         "dosage":1,
         "dosageuom":1,
         "dosageuomcode":1,
         "frequencydescription" :1 ,
         "frequencytype" :1,
         "localfrequencydescription" :1 ,
         "patientuid" : 1,
         "patientvisituid":1,
         "patientdob":1,
         "patienttitle":1,
         "patienttitlelocal":1,
         "patientgender":1,
         "patientgenderlocal":1,
         "departmentcode":1,
         "departmentname":1,
         "storename":1,
         "storecode":1,
         "filluser" :1,
         "ipfillnumber":1,
         "isdosagenotapplicable" :1,
         "orderitemname":1,
         "admininstruction" : 1 ,
         "routelocallang" :1,
         "dosageUOMlocal": 1,
         "quantityUOMlocal": 1,
         "dosagenotapplicabe" :1,
         "indication" :1,
         "careproviderlastname" :1,
         "careprovidertitle":1,
         "careprovidertitlelocal":1,
         "careprovidername" :1,
         "careprovidercode" :1,
         "routelocallang" :1,
         "beduid2":1,
         "warduid2":1,
         "wardname": "$ward.name",
         "wardcode": "$ward.code",
         "bedname": "$bed.name",
}
}
]
}
}